// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id                String    @id @default(uuid())
  name              String
  firstName         String?
  lastName          String?
  email             String    @unique
  password          String?   // Nullable for OAuth users
  phone             String?
  profileImage      String?
  bio               String?   @db.Text
  rating            Float     @default(0)
  totalRides        Int       @default(0)
  verified          Boolean   @default(false)

  // Additional personal details
  dateOfBirth       DateTime?
  gender            String?
  address           String?

  // Verification documents
  idDocumentUrl     String?
  idType            String?   // e.g., "aadhar", "pan", "passport"
  idNumber          String?
  idVerified        Boolean   @default(false)
  driverLicenseUrl  String?
  driverLicenseNumber String?
  driverLicenseVerified Boolean @default(false)

  // Role-Based Access Control
  role              String    @default("passenger") // admin, driver, passenger

  // Account Suspension
  suspended         Boolean   @default(false)
  suspendedAt       DateTime?
  suspensionReason  String?   @db.Text
  suspendedBy       String?   // Admin user ID

  // Privacy Settings
  profileVisibility String    @default("public") // public, friends, private
  showEmail         Boolean   @default(false)
  showPhone         Boolean   @default(false)
  showRideHistory   Boolean   @default(true)

  // Email verification
  emailVerified     DateTime?
  verificationToken String?

  // Password reset
  resetToken        String?
  resetTokenExpiry  DateTime?

  // Two-factor authentication
  twoFactorEnabled  Boolean   @default(false)
  twoFactorSecret   String?

  // Preferences and interests (JSON)
  preferences       Json?
  interests         Json?

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  ridesAsDriver      Ride[]         @relation("DriverRides")
  ridesAsPassenger   Booking[]      @relation("PassengerBookings")
  vehicles           Vehicle[]
  payments           Payment[]      @relation("UserPayments")
  paymentsPaid       Payment[]      @relation("PaymentsPaid")
  paymentsReceived   Payment[]      @relation("PaymentsReceived")
  sentMessages       Message[]      @relation("SentMessages")
  receivedMessages   Message[]      @relation("ReceivedMessages")
  reviews            Review[]       @relation("UserReviews") // Reviews given by this user
  accounts           Account[]
  sessions           Session[]
  savedSearches      SavedSearch[]  @relation("UserSavedSearches")
  socialProfiles     SocialProfile[]
  userBadges         UserBadge[]
  friendshipsRequested Friendship[] @relation("FriendshipRequester")
  friendshipsReceived Friendship[] @relation("FriendshipAddressee")
  notificationsSent  Notification[] @relation("NotificationSender")
  notificationsReceived Notification[] @relation("NotificationTarget")
  announcementsCreated Announcement[] @relation("AnnouncementCreator")
  announcementDismissals AnnouncementDismissal[]
  adminMessagesReceived AdminMessage[] @relation("AdminMessageRecipient")
  adminMessagesSent  AdminMessage[] @relation("AdminMessageSender")
  activityLogs       ActivityLog[]
  supportTickets     SupportTicket[] @relation("UserSupportTickets")
  reportsMade        Report[]       @relation("Reporter")
  reportsReceived    Report[]       @relation("Reported")
  supportChatsAsUser SupportChat[]  @relation("UserSupportChats")
  supportChatsAsAdmin SupportChat[] @relation("AdminSupportChats")
  supportChatMessages SupportChatMessage[]
  
  @@map("users")
}

model SupportTicket {
  id          String   @id @default(uuid())
  userId      String
  subject     String
  message     String   @db.Text
  status      String   @default("open") // open, in_progress, resolved, closed
  priority    String   @default("medium") // low, medium, high
  category    String   @default("general") // general, billing, technical, ride_issue
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation("UserSupportTickets", fields: [userId], references: [id], onDelete: Cascade)

  @@map("support_tickets")
}

model Vehicle {
  id          String   @id @default(uuid())
  userId      String
  make        String
  model       String
  year        String
  plateNumber String
  color       String?
  fuelType    String?  @default("petrol") // petrol, diesel, electric, cng, hybrid
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  rides       Ride[]

  @@map("vehicles")
}

model Ride {
  id          String    @id @default(uuid())
  driverId    String
  vehicleId   String?
  from        String
  fromLat     Float?
  fromLng     Float?
  to          String
  toLat       Float?
  toLng       Float?
  date        DateTime
  time        String
  seats       Int
  price       Float
  status      String    @default("active") // active, completed, cancelled
  amenities   String?   @db.Text
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Advanced features
  flexibleDates Boolean   @default(false)
  flexibleDays  Int       @default(0) // Â±days flexible
  allowPooling  Boolean   @default(true)
  pooledWith    String?   // IDs of other rides pooled together
  distance      Float?    // Distance in km
  duration      Int?      // Duration in minutes
  waypoints     String?   @db.Text // JSON array of waypoints
  
  // Relations
  driver      User      @relation("DriverRides", fields: [driverId], references: [id], onDelete: Cascade)
  vehicle     Vehicle?  @relation(fields: [vehicleId], references: [id])
  bookings    Booking[] @relation("RideBookings")
  reviews     Review[]  @relation("RideReviews")
  messages    Message[]
  
  @@index([from, to, date])
  @@index([fromLat, fromLng, toLat, toLng])
  @@map("rides")
}

model Booking {
  id              String    @id @default(uuid())
  rideId          String
  passengerId     String
  seats           Int
  status          String    @default("pending") // pending, confirmed, cancelled
  paymentIntentId String?
  paymentStatus   String    @default("pending") // pending, paid, failed
  amount          Float?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  ride            Ride      @relation("RideBookings", fields: [rideId], references: [id], onDelete: Cascade)
  passenger       User      @relation("PassengerBookings", fields: [passengerId], references: [id], onDelete: Cascade)
  payments        Payment[]
  messages        Message[]
  
  @@map("bookings")
}

model Payment {
  id              String   @id @default(uuid())
  bookingId       String
  userId          String   // Deprecated - use payerId instead
  payerId         String   // User who made the payment
  receiverId      String   // User who receives the payment
  amount          Float
  currency        String   @default("usd")
  status          String   // completed, pending, failed, refunded, partially_refunded
  method          String?  // card, cash, wallet, etc.
  stripePaymentId String?
  refundAmount    Float?   @default(0)
  refundReason    String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  booking         Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  user            User     @relation("UserPayments", fields: [userId], references: [id], onDelete: Cascade)
  payer           User     @relation("PaymentsPaid", fields: [payerId], references: [id], onDelete: Cascade)
  receiver        User     @relation("PaymentsReceived", fields: [receiverId], references: [id], onDelete: Cascade)
  
  @@map("payments")
}

model Message {
  id          String   @id @default(uuid())
  bookingId   String?
  rideId      String?
  senderId    String
  receiverId  String
  content     String   @db.Text
  read        Boolean  @default(false)
  createdAt   DateTime @default(now())
  
  // Relations
  booking     Booking? @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  ride        Ride?    @relation(fields: [rideId], references: [id])
  sender      User     @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiver    User     @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)
  
  @@map("messages")
}

model Review {
  id          String    @id @default(uuid())
  rideId      String
  reviewerId  String
  rating      Int       // 1-5
  comment     String?
  createdAt   DateTime  @default(now())
  
  // Relations
  ride        Ride      @relation("RideReviews", fields: [rideId], references: [id], onDelete: Cascade)
  reviewer    User      @relation("UserReviews", fields: [reviewerId], references: [id], onDelete: Cascade)
  
  @@map("reviews")
}

// NextAuth models for OAuth
model Account {
  id                String  @id @default(uuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime
  
  @@unique([identifier, token])
  @@map("verification_tokens")
}

model SavedSearch {
  id            String   @id @default(uuid())
  userId        String
  name          String
  from          String
  to            String
  flexibleDates Boolean  @default(false)
  maxPrice      Float?
  minSeats      Int?
  amenities     String?  @db.Text
  alertEnabled  Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  user          User     @relation("UserSavedSearches", fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("saved_searches")
}

model PopularRoute {
  id           String   @id @default(uuid())
  from         String
  to           String
  fromLat      Float
  fromLng      Float
  toLat        Float
  toLng        Float
  searchCount  Int      @default(1)
  rideCount    Int      @default(0)
  lastSearched DateTime @default(now())
  
  @@unique([from, to])
  @@index([searchCount])
  @@map("popular_routes")
}
model SocialProfile {
  id          String   @id @default(uuid())
  userId      String
  provider    String   // e.g., "facebook", "instagram"
  profileUrl  String
  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("social_profiles")
}

model UserBadge {
  id          String   @id @default(uuid())
  userId      String
  badgeName   String
  description String?   @db.Text
  earnedAt    DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_badges")
}

model Friendship {
  id           String   @id @default(uuid())
  requesterId  String
  addresseeId  String
  status       String   @default("pending") // pending, accepted, rejected
  createdAt    DateTime @default(now())

  requester    User     @relation("FriendshipRequester", fields: [requesterId], references: [id], onDelete: Cascade)
  addressee    User     @relation("FriendshipAddressee", fields: [addresseeId], references: [id], onDelete: Cascade)

  @@unique([requesterId, addresseeId])
  @@map("friendships")
}


model Notification {
  id           String    @id @default(uuid())
  title        String
  message      String    @db.Text
  type         String    @default("info") // info, warning, success, error
  targetType   String    // all, drivers, passengers, verified, individual
  targetUserId String?   // For individual notifications
  sentBy       String    // Admin user ID
  status       String    @default("sent") // sent, delivered, read, failed
  createdAt    DateTime  @default(now())
  
  // Relations
  targetUser   User?     @relation("NotificationTarget", fields: [targetUserId], references: [id], onDelete: Cascade)
  sender       User      @relation("NotificationSender", fields: [sentBy], references: [id], onDelete: Cascade)
  
  @@map("notifications")
}

model Announcement {
  id           String    @id @default(uuid())
  title        String
  content      String    @db.Text
  priority     String    @default("medium") // low, medium, high, urgent
  type         String    @default("info") // info, warning, success
  dismissible  Boolean   @default(true)
  active       Boolean   @default(true)
  scheduledFor DateTime?
  expiresAt    DateTime?
  createdBy    String
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  
  // Relations
  creator      User      @relation("AnnouncementCreator", fields: [createdBy], references: [id], onDelete: Cascade)
  dismissals   AnnouncementDismissal[]
  
  @@map("announcements")
}

model AnnouncementDismissal {
  id             String       @id @default(uuid())
  announcementId String
  userId         String
  dismissedAt    DateTime     @default(now())
  
  // Relations
  announcement   Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([announcementId, userId])
  @@map("announcement_dismissals")
}

model AdminMessage {
  id        String    @id @default(uuid())
  userId    String    // Recipient
  adminId   String    // Sender (admin)
  subject   String
  message   String    @db.Text
  read      Boolean   @default(false)
  readAt    DateTime?
  createdAt DateTime  @default(now())
  
  // Relations
  user      User      @relation("AdminMessageRecipient", fields: [userId], references: [id], onDelete: Cascade)
  admin     User      @relation("AdminMessageSender", fields: [adminId], references: [id], onDelete: Cascade)
  
  @@map("admin_messages")
}

model ActivityLog {
  id          String   @id @default(uuid())
  userId      String?  // Actor (null for system events)
  actorType   String   @default("user") // user, admin, system
  actionType  String   // login, logout, create_ride, suspend_user, etc.
  targetType  String?  // user, ride, booking, payment, etc.
  targetId    String?  // ID of affected entity
  description String   @db.Text
  ipAddress   String?
  userAgent   String?  @db.Text
  status      String   @default("success") // success, failure, pending
  metadata    Json?    // Additional context
  createdAt   DateTime @default(now())
  
  // Relations
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  @@index([userId])
  @@index([actionType])
  @@index([createdAt])
  @@map("activity_logs")
}

model Report {
  id          String   @id @default(uuid())
  reporterId  String
  reportedId  String
  reason      String
  description String?  @db.Text
  status      String   @default("pending") // pending, reviewed, resolved, dismissed
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  reporter    User     @relation("Reporter", fields: [reporterId], references: [id], onDelete: Cascade)
  reported    User     @relation("Reported", fields: [reportedId], references: [id], onDelete: Cascade)

  @@map("reports")
}

model SupportChat {
  id          String   @id @default(uuid())
  userId      String
  adminId     String?  // Assigned admin, null if unassigned
  subject     String
  status      String   @default("open") // open, in_progress, resolved, closed
  priority    String   @default("medium") // low, medium, high, urgent
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation("UserSupportChats", fields: [userId], references: [id], onDelete: Cascade)
  admin       User?    @relation("AdminSupportChats", fields: [adminId], references: [id], onDelete: SetNull)
  messages    SupportChatMessage[]

  @@index([userId])
  @@index([adminId])
  @@index([status])
  @@map("support_chats")
}

model SupportChatMessage {
  id        String   @id @default(uuid())
  chatId    String
  senderId  String
  content   String   @db.Text
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  chat      SupportChat @relation(fields: [chatId], references: [id], onDelete: Cascade)
  sender    User        @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([chatId])
  @@map("support_chat_messages")
}
